# render.yaml
# Configuration pour déployer Regalica Notebook sur Render

services:
  # Backend Express.js
  - type: web
    name: regalica-backend
    runtime: node
    region: frankfurt
    plan: starter
    rootDir: ./backend
    buildCommand: npm ci --legacy-peer-deps
    startCommand: npm start
    healthCheckPath: /health/ready
    envVars:
      - key: NODE_ENV
        value: production
      - key: SERVER_PORT
        value: 10000
      - key: LOG_LEVEL
        value: info
      - key: DATABASE_URL
        fromDatabase:
          name: regalica-db
          property: connectionString
      - key: DB_SCHEMA
        value: nbk
      - key: MAX_UPLOAD_MB
        value: 100
      - key: EMBED_API_URL
        value: http://embedder:8000
      - key: EMBED_MODEL_NAME
        value: intfloat/multilingual-e5-large
      - key: CHUNK_TOKENS_MAX
        value: 1800
      - key: CHUNK_OVERLAP_PCT
        value: 0.25
      - key: ALLOWED_MIME
        value: application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/html,text/plain
      - key: OCR_ENABLE
        value: false
      - key: RAG_TOP_K
        value: 50
      - key: RAG_CITATIONS_MIN
        value: 2
      - key: RAG_CONFIDENCE_THRESHOLD
        value: 0.6
      - key: RERANKER_API_URL
        value: http://reranker:8000
      - key: LLM_API_URL
        value: http://ollama:11434
      - key: LLM_MODEL_NAME
        value: qwen2:7b-instruct
    autoDeploy: true

  # Microservice Embedder
  - type: web
    name: regalica-embedder
    runtime: python
    region: frankfurt
    plan: starter
    rootDir: ./embedder
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app:app --host 0.0.0.0 --port 8000
    envVars:
      - key: EMBED_MODEL_NAME
        value: intfloat/multilingual-e5-large
    healthCheckPath: /health
    autoDeploy: true

  # Microservice Reranker (Bloc 3)
  - type: web
    name: regalica-reranker
    runtime: python
    region: frankfurt
    plan: starter
    rootDir: ./reranker
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app:app --host 0.0.0.0 --port 8000
    envVars:
      - key: RERANKER_MODEL_NAME
        value: BAAI/bge-reranker-v2-m3
    healthCheckPath: /health
    autoDeploy: true

  # Frontend Angular
  - type: web
    name: regalica-frontend
    runtime: static
    plan: starter
    rootDir: ./frontend
    buildCommand: npm ci --legacy-peer-deps && npm run build -- --configuration=production
    staticPublishPath: ./dist/regalica-frontend/browser
    envVars:
      - key: NODE_ENV
        value: production
    headers:
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    autoDeploy: true

# Base de données PostgreSQL
databases:
  - name: regalica-db
    databaseName: regalica
    user: regalica_user
    plan: free
    region: frankfurt
    ipAllowList: []
