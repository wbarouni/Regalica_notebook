<!-- Header -->
<header class="bg-white border-b border-gray-200" data-testid="header">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <div class="flex items-center">
        <svg class="h-8 w-8 text-black mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h1 class="text-xl font-semibold text-black" data-testid="app-title">{{ title }}</h1>
      </div>
      <div class="flex items-center space-x-4">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800" data-testid="version-badge">
          v0.1.0
        </span>
      </div>
    </div>
  </div>
</header>

<!-- Main Layout - 3 Panneaux -->
<main class="flex h-screen bg-gray-50" data-testid="main-layout">
  
  <!-- Panneau 1: Sources -->
  <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col" data-testid="sources-panel">
    <div class="p-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-black mb-4" data-testid="sources-title">Sources</h2>
      
      <!-- Upload Section -->
      <div class="space-y-3" data-testid="upload-section">
        <input 
          type="file" 
          accept=".pdf"
          (change)="onFileSelected($event)"
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-black file:text-white hover:file:bg-gray-800"
          data-testid="file-input"
        />
        
        <button 
          (click)="uploadSource()"
          [disabled]="!uploadFile || isUploading"
          class="w-full py-2 px-4 bg-black text-white rounded-md hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          data-testid="upload-button"
        >
          <span *ngIf="!isUploading">Uploader PDF</span>
          <span *ngIf="isUploading">Upload en cours...</span>
        </button>
        
        <div *ngIf="uploadError" class="text-red-600 text-sm" data-testid="upload-error">
          {{ uploadError }}
        </div>
      </div>
    </div>
    
    <!-- Sources List -->
    <div class="flex-1 overflow-y-auto p-4" data-testid="sources-list">
      <div *ngIf="sources.length === 0" class="text-gray-500 text-center py-8" data-testid="no-sources">
        Aucune source uploadée
      </div>
      
      <div *ngFor="let source of sources; trackBy: (index, item) => item.source_id" 
           class="mb-3 p-3 border border-gray-200 rounded-md cursor-pointer hover:bg-gray-50"
           [class.bg-gray-100]="selectedSource?.source_id === source.source_id"
           (click)="selectSource(source)"
           [attr.data-testid]="'source-item-' + source.source_id">
        
        <div class="font-medium text-black truncate" data-testid="source-filename">
          {{ source.filename }}
        </div>
        <div class="text-sm text-gray-600 mt-1" data-testid="source-metadata">
          {{ formatFileSize(source.size) }} • {{ formatDate(source.uploaded_at) }}
        </div>
        <div *ngIf="source.processing_status" 
             class="text-xs text-gray-500 mt-1" 
             data-testid="source-status">
          {{ source.processing_status }}
        </div>
      </div>
    </div>
  </div>

  <!-- Panneau 2: Chat -->
  <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col" data-testid="chat-panel">
    <div class="p-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-black" data-testid="chat-title">Chat</h2>
      <div *ngIf="selectedSource" class="text-sm text-gray-600 mt-1" data-testid="selected-source">
        Source: {{ selectedSource.filename }}
      </div>
      <div *ngIf="!selectedSource" class="text-sm text-gray-500 mt-1" data-testid="no-source-selected">
        Sélectionnez une source pour commencer
      </div>
    </div>
    
    <!-- Messages -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4" data-testid="chat-messages">
      <div *ngIf="chatMessages.length === 0 && selectedSource" 
           class="text-gray-500 text-center py-8" 
           data-testid="no-messages">
        Posez une question sur le document
      </div>
      
      <div *ngFor="let msg of chatMessages; trackBy: (index, item) => item.timestamp" 
           class="space-y-2" 
           [attr.data-testid]="'chat-message-' + $index">
        
        <!-- Question utilisateur -->
        <div class="bg-gray-100 p-3 rounded-md" data-testid="user-message">
          <div class="font-medium text-black">Vous</div>
          <div class="text-gray-800 mt-1">{{ msg.message }}</div>
        </div>
        
        <!-- Réponse IA -->
        <div class="bg-black text-white p-3 rounded-md" data-testid="ai-response">
          <div class="font-medium">Assistant</div>
          <div class="mt-1">{{ msg.answer }}</div>
          <div class="text-xs text-gray-300 mt-2">{{ formatDate(msg.timestamp) }}</div>
        </div>
      </div>
    </div>
    
    <!-- Input Chat -->
    <div class="p-4 border-t border-gray-200" data-testid="chat-input-section">
      <div *ngIf="chatError" class="text-red-600 text-sm mb-2" data-testid="chat-error">
        {{ chatError }}
      </div>
      
      <div class="flex space-x-2">
        <input 
          type="text"
          [(ngModel)]="chatMessage"
          (keypress)="onChatKeyPress($event)"
          placeholder="Posez une question..."
          [disabled]="!selectedSource || isChatting"
          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent disabled:bg-gray-100"
          data-testid="chat-input"
        />
        
        <button 
          (click)="sendChatMessage()"
          [disabled]="!chatMessage.trim() || !selectedSource || isChatting"
          class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed"
          data-testid="send-button"
        >
          <span *ngIf="!isChatting">Envoyer</span>
          <span *ngIf="isChatting">...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Panneau 3: Viewer -->
  <div class="w-1/3 bg-white flex flex-col" data-testid="viewer-panel">
    <div class="p-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-black" data-testid="viewer-title">Viewer</h2>
      <div *ngIf="selectedSource" class="text-sm text-gray-600 mt-1" data-testid="viewer-source">
        {{ selectedSource.filename }}
      </div>
    </div>
    
    <div class="flex-1 p-4" data-testid="viewer-content">
      <div *ngIf="!selectedSource" 
           class="h-full flex items-center justify-center text-gray-500" 
           data-testid="no-document">
        <div class="text-center">
          <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p>Sélectionnez un document pour le visualiser</p>
        </div>
      </div>
      
      <div *ngIf="selectedSource" 
           class="h-full border border-gray-200 rounded-md bg-gray-50 flex items-center justify-center" 
           data-testid="document-viewer">
        <div class="text-center text-gray-600">
          <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="font-medium">{{ selectedSource.filename }}</p>
          <p class="text-sm mt-1">{{ formatFileSize(selectedSource.size) }}</p>
          <p class="text-xs text-gray-500 mt-2">Viewer PDF à implémenter</p>
        </div>
      </div>
    </div>
  </div>
</main>

<router-outlet></router-outlet>
